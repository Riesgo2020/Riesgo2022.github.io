<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Registros de Incidencias</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --warning-color: #f6c23e;
            --info-color: #36b9cc;
            --danger-color: #e74a3b;
            --purple-color: #6f42c1;
            --light-bg: #f8f9fc;
            --card-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        
        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #5a5c69;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), #2e59d9);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.2);
        }
        
        .card {
            border: none;
            border-radius: 0.5rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 0.5rem 0.5rem 0 0 !important;
            padding: 1rem 1.25rem;
            font-weight: 600;
        }
        
        .global-card .card-header {
            background-color: var(--info-color);
        }
        
        .description-card .card-header {
            background-color: var(--danger-color);
        }
        
        .service-card .card-header {
            background-color: var(--purple-color);
        }
        
        .table-responsive {
            border-radius: 0 0 0.5rem 0.5rem;
        }
        
        .table th {
            background-color: #f8f9fc;
            color: var(--primary-color);
            font-weight: 600;
            border-top: none;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
            color: white;
        }
        
        .btn-info {
            background-color: var(--info-color);
            border-color: var(--info-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
        }
        
        .btn-purple {
            background-color: var(--purple-color);
            border-color: var(--purple-color);
            color: white;
        }
        
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-container input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--secondary-color);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: #dddfeb;
        }
        
        .footer {
            margin-top: 3rem;
            padding: 1.5rem 0;
            background-color: white;
            border-top: 1px solid #e3e6f0;
            color: var(--secondary-color);
        }
        
        .control-panel {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }
        
        .unified-badge {
            background-color: var(--warning-color);
            color: white;
            font-weight: bold;
        }
        
        .global-badge {
            background-color: var(--info-color);
            color: white;
            font-weight: bold;
        }
        
        .description-badge {
            background-color: var(--danger-color);
            color: white;
            font-weight: bold;
        }
        
        .service-badge {
            background-color: var(--purple-color);
            color: white;
            font-weight: bold;
        }
        
        .mode-description {
            background-color: #f8f9fc;
            border-left: 4px solid var(--primary-color);
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }
        
        .mode-description.info {
            border-left-color: var(--info-color);
        }
        
        .mode-description.warning {
            border-left-color: var(--warning-color);
        }
        
        .mode-description.danger {
            border-left-color: var(--danger-color);
        }
        
        .mode-description.purple {
            border-left-color: var(--purple-color);
        }
        
        .description-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e3e6f0;
            border-radius: 0.25rem;
            padding: 0.5rem;
            background-color: #f8f9fc;
        }
        
        .description-item {
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.25rem;
            background-color: white;
            border-radius: 0.25rem;
            border-left: 3px solid var(--purple-color);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold"><i class="fas fa-file-alt me-3"></i>Organizador de Registros de Incidencias</h1>
                    <p class="lead mb-0">Carga tu archivo .txt y organiza automáticamente las incidencias por mes</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="file-input-container">
                        <button class="btn btn-light btn-lg px-4">
                            <i class="fas fa-file-upload me-2"></i>Cargar archivo .txt
                        </button>
                        <input type="file" id="fileInput" accept=".txt">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="control-panel">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">Opciones de visualización</h5>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="viewMode" id="viewNormal" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="viewNormal">Vista Normal</label>

                        <input type="radio" class="btn-check" name="viewMode" id="viewUnified" autocomplete="off">
                        <label class="btn btn-outline-warning" for="viewUnified">Unificar por Mes</label>

                        <input type="radio" class="btn-check" name="viewMode" id="viewGlobal" autocomplete="off">
                        <label class="btn btn-outline-info" for="viewGlobal">Unificar Global</label>

                        <input type="radio" class="btn-check" name="viewMode" id="viewService" autocomplete="off">
                        <label class="btn btn-outline-purple" for="viewService">Unificar por Servicio</label>
                    </div>
                    <button class="btn btn-success px-4 ms-2" id="exportBtn">
                        <i class="fas fa-file-excel me-2"></i>Exportar
                    </button>
                </div>
            </div>
        </div>

        <div id="modeDescription" class="mode-description">
            <h6><i class="fas fa-info-circle me-2"></i>Vista Normal</h6>
            <p class="mb-0">Muestra todas las incidencias organizadas por mes, tal como aparecen en el archivo original.</p>
        </div>

        <div id="tablesContainer" class="mb-4">
            <div class="empty-state" id="emptyState">
                <i class="fas fa-file-alt"></i>
                <h3>No hay datos cargados</h3>
                <p>Selecciona un archivo .txt con el formato de registro de incidencias para comenzar</p>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container text-center">
            <p class="mb-0">Organizador de Registros de Incidencias &copy; 2023</p>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const tablesContainer = document.getElementById('tablesContainer');
            const emptyState = document.getElementById('emptyState');
            const exportBtn = document.getElementById('exportBtn');
            const viewNormal = document.getElementById('viewNormal');
            const viewUnified = document.getElementById('viewUnified');
            const viewGlobal = document.getElementById('viewGlobal');
            const viewService = document.getElementById('viewService');
            const modeDescription = document.getElementById('modeDescription');
            
            let allData = [];
            let viewMode = 'normal'; // 'normal', 'unified', 'global', 'service'
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    processFileContent(content);
                };
                reader.readAsText(file);
            });
            
            function updateModeDescription() {
                let title, text, className;
                
                switch(viewMode) {
                    case 'normal':
                        title = 'Vista Normal';
                        text = 'Muestra todas las incidencias organizadas por mes, tal como aparecen en el archivo original.';
                        className = '';
                        break;
                    case 'unified':
                        title = 'Unificar por Mes';
                        text = 'Agrupa incidencias con el mismo Canal y Descripción dentro de cada mes, mostrando cuántas veces se repiten.';
                        className = 'warning';
                        break;
                    case 'global':
                        title = 'Unificar Global';
                        text = 'Agrupa todas las incidencias con el mismo Canal y Descripción de todos los meses, mostrando frecuencia total y meses afectados.';
                        className = 'info';
                        break;
                    case 'service':
                        title = 'Unificar por Servicio';
                        text = 'Agrupa todas las incidencias por Servicio (Canal), mostrando todas las descripciones de problemas reportados para cada servicio.';
                        className = 'purple';
                        break;
                }
                
                modeDescription.innerHTML = `
                    <h6><i class="fas fa-info-circle me-2"></i>${title}</h6>
                    <p class="mb-0">${text}</p>
                `;
                modeDescription.className = `mode-description ${className}`;
            }
            
            viewNormal.addEventListener('change', function() {
                if (this.checked) {
                    viewMode = 'normal';
                    updateModeDescription();
                    renderTables();
                }
            });
            
            viewUnified.addEventListener('change', function() {
                if (this.checked) {
                    viewMode = 'unified';
                    updateModeDescription();
                    renderTables();
                }
            });
            
            viewGlobal.addEventListener('change', function() {
                if (this.checked) {
                    viewMode = 'global';
                    updateModeDescription();
                    renderTables();
                }
            });
            
            viewService.addEventListener('change', function() {
                if (this.checked) {
                    viewMode = 'service';
                    updateModeDescription();
                    renderTables();
                }
            });
            
            function processFileContent(content) {
                allData = [];
                const lines = content.split('\n');
                let currentMonth = '';
                
                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;
                    
                    // Check if line is a month header (starts with a letter, not a digit or whitespace)
                    if (/^[A-Za-z]/.test(line) && !line.includes('-')) {
                        currentMonth = line;
                        allData.push({ month: currentMonth, entries: [] });
                    } else if (currentMonth && /^\d{2}\/\d{2}/.test(line)) {
                        // Process entry line
                        const entry = parseEntryLine(line);
                        if (entry) {
                            const currentMonthData = allData.find(m => m.month === currentMonth);
                            if (currentMonthData) {
                                currentMonthData.entries.push(entry);
                            }
                        }
                    }
                });
                
                renderTables();
            }
            
            function parseEntryLine(line) {
                // Expected format: "01/08 14:25 - 14:30 Internet Banking Transaccional (Lentitud por alta concurrencia)"
                const regex = /^(\d{2}\/\d{2})\s+(\d{2}:\d{2})\s+-\s+(\d{2}:\d{2})\s+(.+?)\s+\((.+)\)$/;
                const match = line.match(regex);
                
                if (match) {
                    return {
                        date: match[1],
                        startTime: match[2],
                        endTime: match[3],
                        channel: match[4],
                        description: match[5],
                        count: 1,
                        month: getMonthFromDate(match[1])
                    };
                }
                
                // Alternative format without parentheses
                const altRegex = /^(\d{2}\/\d{2})\s+(\d{2}:\d{2})\s+-\s+(\d{2}:\d{2})\s+(.+)$/;
                const altMatch = line.match(altRegex);
                
                if (altMatch) {
                    // Try to separate channel and description
                    const details = altMatch[4].split(' ');
                    const channel = details[0];
                    const description = details.slice(1).join(' ');
                    
                    return {
                        date: altMatch[1],
                        startTime: altMatch[2],
                        endTime: altMatch[3],
                        channel: channel,
                        description: description,
                        count: 1,
                        month: getMonthFromDate(altMatch[1])
                    };
                }
                
                return null;
            }
            
            function getMonthFromDate(dateStr) {
                const months = [
                    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                ];
                const [day, month] = dateStr.split('/');
                return months[parseInt(month) - 1];
            }
            
            function unifyEntries(entries) {
                const unifiedMap = new Map();
                
                entries.forEach(entry => {
                    const key = `${entry.channel}|${entry.description}`;
                    
                    if (unifiedMap.has(key)) {
                        const existing = unifiedMap.get(key);
                        existing.count += 1;
                        // Keep track of all dates for this entry
                        if (!existing.dates) existing.dates = [existing.date];
                        existing.dates.push(entry.date);
                        // Update to show date range
                        existing.date = `${existing.dates[0]} - ${existing.dates[existing.dates.length-1]}`;
                    } else {
                        unifiedMap.set(key, {...entry});
                    }
                });
                
                return Array.from(unifiedMap.values());
            }
            
            function unifyEntriesGlobal() {
                const allEntries = [];
                allData.forEach(monthData => {
                    allEntries.push(...monthData.entries);
                });
                
                const globalMap = new Map();
                
                allEntries.forEach(entry => {
                    const key = `${entry.channel}|${entry.description}`;
                    
                    if (globalMap.has(key)) {
                        const existing = globalMap.get(key);
                        existing.count += 1;
                        // Keep track of all months for this entry
                        if (!existing.months) existing.months = new Set([existing.month]);
                        existing.months.add(entry.month);
                        // Update to show months affected
                        existing.monthsList = Array.from(existing.months).sort((a, b) => {
                            const monthsOrder = [
                                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                            ];
                            return monthsOrder.indexOf(a) - monthsOrder.indexOf(b);
                        });
                    } else {
                        globalMap.set(key, {
                            ...entry,
                            months: new Set([entry.month]),
                            monthsList: [entry.month]
                        });
                    }
                });
                
                return Array.from(globalMap.values());
            }
            
            function unifyEntriesByService() {
                const allEntries = [];
                allData.forEach(monthData => {
                    allEntries.push(...monthData.entries);
                });
                
                const serviceMap = new Map();
                
                allEntries.forEach(entry => {
                    const key = entry.channel;
                    
                    if (serviceMap.has(key)) {
                        const existing = serviceMap.get(key);
                        existing.totalCount += 1;
                        
                        // Track unique descriptions for this service
                        if (!existing.descriptions) {
                            existing.descriptions = new Map();
                        }
                        
                        if (existing.descriptions.has(entry.description)) {
                            const desc = existing.descriptions.get(entry.description);
                            desc.count += 1;
                            if (!desc.months) desc.months = new Set([entry.month]);
                            desc.months.add(entry.month);
                            desc.monthsList = Array.from(desc.months).sort((a, b) => {
                                const monthsOrder = [
                                    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                                ];
                                return monthsOrder.indexOf(a) - monthsOrder.indexOf(b);
                            });
                        } else {
                            existing.descriptions.set(entry.description, {
                                description: entry.description,
                                count: 1,
                                months: new Set([entry.month]),
                                monthsList: [entry.month]
                            });
                        }
                        
                        // Track all months for this service
                        existing.months.add(entry.month);
                        existing.monthsList = Array.from(existing.months).sort((a, b) => {
                            const monthsOrder = [
                                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                            ];
                            return monthsOrder.indexOf(a) - monthsOrder.indexOf(b);
                        });
                        
                        // Update unique descriptions count
                        existing.uniqueDescriptions = existing.descriptions.size;
                        
                    } else {
                        const descriptions = new Map();
                        descriptions.set(entry.description, {
                            description: entry.description,
                            count: 1,
                            months: new Set([entry.month]),
                            monthsList: [entry.month]
                        });
                        
                        serviceMap.set(key, {
                            channel: entry.channel,
                            totalCount: 1,
                            descriptions: descriptions,
                            uniqueDescriptions: 1,
                            months: new Set([entry.month]),
                            monthsList: [entry.month]
                        });
                    }
                });
                
                return Array.from(serviceMap.values());
            }
            
            function renderTables() {
                tablesContainer.innerHTML = '';
                
                if (allData.length === 0) {
                    emptyState.classList.remove('d-none');
                    return;
                }
                
                emptyState.classList.add('d-none');
                
                if (viewMode === 'global') {
                    renderGlobalTable();
                    return;
                }
                
                if (viewMode === 'service') {
                    renderServiceTable();
                    return;
                }
                
                allData.forEach(monthData => {
                    if (monthData.entries.length === 0) return;
                    
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    const cardHeader = document.createElement('div');
                    cardHeader.className = 'card-header d-flex justify-content-between align-items-center';
                    
                    const entryCount = viewMode === 'unified' 
                        ? unifyEntries(monthData.entries).length 
                        : monthData.entries.length;
                    
                    cardHeader.innerHTML = `
                        <span><i class="fas fa-calendar-alt me-2"></i>${monthData.month}</span>
                        <span class="badge bg-light text-dark">${entryCount} incidencias</span>
                    `;
                    
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'table-responsive';
                    
                    const table = document.createElement('table');
                    table.className = 'table table-hover table-striped';
                    
                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr>
                            <th>Fecha</th>
                            <th>Hora inicio</th>
                            <th>Hora fin</th>
                            <th>Canal</th>
                            <th>Descripción</th>
                            ${viewMode === 'unified' ? '<th>Veces reportada</th>' : ''}
                        </tr>
                    `;
                    
                    const tbody = document.createElement('tbody');
                    
                    const entriesToShow = viewMode === 'unified' 
                        ? unifyEntries(monthData.entries) 
                        : monthData.entries;
                    
                    entriesToShow.forEach(entry => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${entry.date}</td>
                            <td>${entry.startTime}</td>
                            <td>${entry.endTime}</td>
                            <td>${entry.channel}</td>
                            <td>${entry.description}</td>
                            ${viewMode === 'unified' ? `<td><span class="badge unified-badge">${entry.count}</span></td>` : ''}
                        `;
                        tbody.appendChild(row);
                    });
                    
                    table.appendChild(thead);
                    table.appendChild(tbody);
                    tableContainer.appendChild(table);
                    
                    card.appendChild(cardHeader);
                    card.appendChild(tableContainer);
                    
                    tablesContainer.appendChild(card);
                });
            }
            
            function renderGlobalTable() {
                const globalEntries = unifyEntriesGlobal();
                
                const card = document.createElement('div');
                card.className = 'card global-card';
                
                const cardHeader = document.createElement('div');
                cardHeader.className = 'card-header d-flex justify-content-between align-items-center';
                cardHeader.innerHTML = `
                    <span><i class="fas fa-globe me-2"></i>Vista Global Unificada</span>
                    <span class="badge bg-light text-dark">${globalEntries.length} tipos de incidencias</span>
                `;
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'table-responsive';
                
                const table = document.createElement('table');
                table.className = 'table table-hover table-striped';
                
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Canal</th>
                        <th>Descripción</th>
                        <th>Total de veces reportada</th>
                        <th>Meses afectados</th>
                    </tr>
                `;
                
                const tbody = document.createElement('tbody');
                
                globalEntries.sort((a, b) => b.count - a.count);
                
                globalEntries.forEach(entry => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${entry.channel}</td>
                        <td>${entry.description}</td>
                        <td><span class="badge global-badge">${entry.count}</span></td>
                        <td>${entry.monthsList.join(', ')}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                table.appendChild(thead);
                table.appendChild(tbody);
                tableContainer.appendChild(table);
                
                card.appendChild(cardHeader);
                card.appendChild(tableContainer);
                
                tablesContainer.appendChild(card);
            }
            
            function renderServiceTable() {
                const serviceEntries = unifyEntriesByService();
                
                const card = document.createElement('div');
                card.className = 'card service-card';
                
                const cardHeader = document.createElement('div');
                cardHeader.className = 'card-header d-flex justify-content-between align-items-center';
                cardHeader.innerHTML = `
                    <span><i class="fas fa-cogs me-2"></i>Vista por Servicio Unificada</span>
                    <span class="badge bg-light text-dark">${serviceEntries.length} servicios</span>
                `;
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'table-responsive';
                
                const table = document.createElement('table');
                table.className = 'table table-hover table-striped';
                
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Servicio (Canal)</th>
                        <th>Total de incidencias</th>
                        <th>Tipos de problemas</th>
                        <th>Meses afectados</th>
                        <th>Descripciones de problemas</th>
                    </tr>
                `;
                
                const tbody = document.createElement('tbody');
                
                serviceEntries.sort((a, b) => b.totalCount - a.totalCount);
                
                serviceEntries.forEach(service => {
                    const row = document.createElement('tr');
                    
                    // Create descriptions list
                    const descriptionsList = Array.from(service.descriptions.values())
                        .sort((a, b) => b.count - a.count)
                        .map(desc => 
                            `<div class="description-item">
                                <strong>${desc.description}</strong>
                                <span class="badge service-badge ms-2">${desc.count}</span>
                                <br><small class="text-muted">Meses: ${desc.monthsList.join(', ')}</small>
                            </div>`
                        ).join('');
                    
                    row.innerHTML = `
                        <td><strong>${service.channel}</strong></td>
                        <td><span class="badge service-badge">${service.totalCount}</span></td>
                        <td>${service.uniqueDescriptions} tipos</td>
                        <td>${service.monthsList.join(', ')}</td>
                        <td>
                            <div class="description-list">
                                ${descriptionsList}
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                table.appendChild(thead);
                table.appendChild(tbody);
                tableContainer.appendChild(table);
                
                card.appendChild(cardHeader);
                card.appendChild(tableContainer);
                
                tablesContainer.appendChild(card);
            }
            
            exportBtn.addEventListener('click', function() {
                if (allData.length === 0) return;
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                if (viewMode === 'global') {
                    // Export global view
                    const globalEntries = unifyEntriesGlobal();
                    
                    const wsData = [['Canal', 'Descripción', 'Total de veces reportada', 'Meses afectados']];
                    
                    globalEntries.forEach(entry => {
                        wsData.push([
                            entry.channel,
                            entry.description,
                            entry.count,
                            entry.monthsList.join(', ')
                        ]);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(wb, ws, 'Vista Global');
                } else if (viewMode === 'service') {
                    // Export service view
                    const serviceEntries = unifyEntriesByService();
                    
                    const wsData = [['Servicio', 'Total de incidencias', 'Tipos de problemas', 'Meses afectados', 'Descripciones de problemas']];
                    
                    serviceEntries.forEach(service => {
                        const descriptions = Array.from(service.descriptions.values())
                            .sort((a, b) => b.count - a.count)
                            .map(desc => `${desc.description} (${desc.count} veces)`)
                            .join('; ');
                            
                        wsData.push([
                            service.channel,
                            service.totalCount,
                            service.uniqueDescriptions,
                            service.monthsList.join(', '),
                            descriptions
                        ]);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(wb, ws, 'Vista por Servicio');
                } else {
                    // Export monthly views
                    allData.forEach(monthData => {
                        if (monthData.entries.length === 0) return;
                        
                        const entriesToExport = viewMode === 'unified' 
                            ? unifyEntries(monthData.entries) 
                            : monthData.entries;
                        
                        const wsData = viewMode === 'unified'
                            ? [['Fecha', 'Hora inicio', 'Hora fin', 'Canal', 'Descripción', 'Veces reportada']]
                            : [['Fecha', 'Hora inicio', 'Hora fin', 'Canal', 'Descripción']];
                        
                        entriesToExport.forEach(entry => {
                            if (viewMode === 'unified') {
                                wsData.push([
                                    entry.date,
                                    entry.startTime,
                                    entry.endTime,
                                    entry.channel,
                                    entry.description,
                                    entry.count
                                ]);
                            } else {
                                wsData.push([
                                    entry.date,
                                    entry.startTime,
                                    entry.endTime,
                                    entry.channel,
                                    entry.description
                                ]);
                            }
                        });
                        
                        const ws = XLSX.utils.aoa_to_sheet(wsData);
                        XLSX.utils.book_append_sheet(wb, ws, monthData.month.substring(0, 31));
                    });
                }
                
                // Generate and download Excel file
                let fileName = 'registro_incidencias';
                if (viewMode === 'unified') fileName += '_unificado';
                if (viewMode === 'global') fileName += '_global';
                if (viewMode === 'service') fileName += '_por_servicio';
                fileName += '.xlsx';
                
                XLSX.writeFile(wb, fileName);
            });
            
            // Initialize mode description
            updateModeDescription();
        });
    </script>
</body>
</html>
